# Copyright 2022 flashcat.cloud | 快猫星云
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
{{- if eq .Values.nserver.type "internal" -}}
apiVersion: v1
kind: ConfigMap
metadata:
  name: nserver-template
data:
  dingtalk.tpl: |-
    {{`级别状态: S{{.Severity}} {{if .IsRecovered}}Recovered{{else}}Triggered{{end}}
    规则名称: {{.RuleName}}{{if .RuleNote}}
    规则备注: {{.RuleNote}}{{end}}
    监控指标: {{.TagsJSON}}
    {{if .IsRecovered}}恢复时间：{{timeformat .LastEvalTime}}{{else}}触发时间: {{timeformat .TriggerTime}}
    触发时值: {{.TriggerValue}}{{end}}
    `}}
  feishu.tpl: |-
    {{`
    级别状态: S{{.Severity}} {{if .IsRecovered}}Recovered{{else}}Triggered{{end}}
    规则名称: {{.RuleName}}{{if .RuleNote}}
    规则备注: {{.RuleNote}}{{end}}
    监控指标: {{.TagsJSON}}
    {{if .IsRecovered}}恢复时间：{{timeformat .LastEvalTime}}{{else}}触发时间: {{timeformat .TriggerTime}}
    触发时值: {{.TriggerValue}}{{end}}`}}
  mailbody.tpl: |-
    {{`<!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="ie=edge">
        <title>夜莺告警通知</title>
        <style type="text/css">
            .wrapper {
                padding: 15px;
                height: 100%;
            }
            .main {
                width: 600px;
                padding: 30px;
                margin: 0 auto;
                font-size: 12px;
                font-family: verdana,'Microsoft YaHei',Consolas,'Deja Vu Sans Mono','Bitstream Vera Sans Mono';
            }
            header {
                border-radius: 2px 2px 0 0;
            }
            header .title {
                font-size: 16px;
                margin: 0;
            }
            header .sub-desc {
                font-size: 14px;
                margin-top: 6px;
                margin-bottom: 0;
            }
            hr {
                margin: 20px 0;
                height: 0;
                border: none;
            }
            em {
                font-weight: 600;
            }
            table {
                margin: 20px 0;
                width: 100%;
            }
    
            table tbody tr{
                font-weight: 200;
                font-size: 12px;
                height: 32px;
            }
    
            .succ {
                background-color: green;
                color: white;
            }
    
            .fail {
                background-color: red;
                color: white;
            }
    
            table tbody tr th {
                width: 80px;
                text-align: right;
            }
            .text-right {
                text-align: right;
            }
            .body {
                margin-top: 24px;
            }
            .body-text {
                -webkit-font-smoothing: antialiased;
            }
            .body-extra {
                -webkit-font-smoothing: antialiased;
            }
            .body-extra.text-right a {
                text-decoration: none;
            }
            .body-extra.text-right a:hover {
            }
            .button {
                width: 200px;
                height: 50px;
                margin-top: 20px;
                text-align: center;
                border-radius: 2px;
                line-height: 50px;
                font-size: 20px;
                cursor: pointer;
            }
            .button:hover {
                background: rgb(25, 115, 255);
                border-color: rgb(25, 115, 255);
            }
            footer {
                margin-top: 10px;
                text-align: right;
            }
            .footer-logo {
                text-align: right;
            }
            .footer-logo-image {
                width: 108px;
                height: 27px;
                margin-right: 10px;
            }
            .copyright {
                margin-top: 10px;
                font-size: 12px;
                text-align: right;
                -webkit-font-smoothing: antialiased;
            }
        </style>
    </head>
    <body>
    <div class="wrapper">
        <div class="main">
            <header>
                <h3 class="title">{{.RuleName}}</h3>
                <p class="sub-desc"></p>
            </header>
    
            <hr>
    
            <div class="body">
                <table cellspacing="0" cellpadding="0" border="0">
                    <tbody>
                    {{if .IsRecovered}}
                    <tr class="succ">
                        <th>级别状态：</th>
                        <td>S{{.Severity}} Recovered</td>
                    </tr>
                    {{else}}
                    <tr class="fail">
                        <th>级别状态：</th>
                        <td>S{{.Severity}} Triggered</td>
                    </tr>
                    {{end}}
    
                    <tr>
                        <th>策略备注：</th>
                        <td>{{.RuleNote}}</td>
                    </tr>
                    <tr>
                        <th>设备备注：</th>
                        <td>{{.TargetNote}}</td>
                    </tr>
                    <tr>
                        <th>监控指标：</th>
                        <td>{{.TagsJSON}}</td>
                    </tr>
    
                    {{if .IsRecovered}}
                    <tr>
                        <th>恢复时间：</th>
                        <td>{{timeformat .LastEvalTime}}</td>
                    </tr>
                    {{else}}
                    <tr>
                        <th>触发时值：</th>
                        <td>{{.TriggerValue}}</td>
                    </tr>
                    <tr>
                        <th>触发时间：</th>
                        <td>
                            {{timeformat .TriggerTime}}
                        </td>
                    </tr>
                    {{end}}
    
                    <tr>
                        <th>PromQL：</th>
                        <td>
                            {{.PromQl}}
                        </td>
                    </tr>
                    </tbody>
                </table>
    
                <hr>
    
                <footer>
                    <div class="copyright" style="font-style: italic">
                        我们希望与您一起，将监控这个事情，做到极致！
                    </div>
                </footer>
            </div>
        </div>
    </div>
    </body>
    </html>
    `}}
  subject.tpl: |
    {{`{{if .IsRecovered}}Recovered{{else}}Triggered{{end}}: {{.RuleName}} {{.TagsJSON}}
  wecom.tpl: |
    **级别状态**: {{if .IsRecovered}}<font color="info">S{{.Severity}} Recovered</font>{{else}}<font color="warning">S{{.Severity}} Triggered</font>{{end}}
    **规则标题**: {{.RuleName}}{{if .RuleNote}}
    **规则备注**: {{.RuleNote}}{{end}}
    **监控指标**: {{.TagsJSON}}
    {{if .IsRecovered}}**恢复时间**：{{timeformat .LastEvalTime}}{{else}}**触发时间**: {{timeformat .TriggerTime}}
    **触发时值**: {{.TriggerValue}}{{end}}`}}
{{- end -}}
